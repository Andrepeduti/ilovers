<div class="plans-container">
    <div class="header" *ngIf="!selectedPlan">
        <h1>Escolha seu Plano</h1>
        <p>Desbloqueie recursos exclusivos e encontre seu par perfeito mais rápido.</p>
    </div>

    <button class="btn-back" *ngIf="!selectedPlan" (click)="navigateToProfile()">
        <i class="fas fa-arrow-left"></i> Voltar
    </button>
    <button class="btn-back" *ngIf="selectedPlan" (click)="clearSelection()">
        <i class="fas fa-arrow-left"></i> Voltar
    </button>

    <div class="header" *ngIf="selectedPlan">
        <h1>{{ selectedPlan.name }}</h1>
        <p>Valor: R$ {{ selectedPlan.price | number:'1.2-2' }}</p>
    </div>

    <!-- Plan List -->
    <div class="plans-grid" *ngIf="!isLoading && !selectedPlan">

        <!-- FREE PLAN CARD -->
        <div class="plan-card" [class.active-plan]="!isUserPremium">
            <div class="plan-selection-indicator">
                <input type="radio" [checked]="!isUserPremium" disabled>
                <span *ngIf="!isUserPremium">Seu plano atual</span>
            </div>
            <div class="plan-header">
                <h2>Ilovers Free</h2>
                <div class="price">R$ 0,00</div>
                <div class="duration">/ Sempre gratuito</div>
            </div>

            <ul class="features">
                <li><span class="check">✓</span> Encontre pessoas</li>
                <li><span class="check">✓</span> Likes limitados por dia</li>
                <li><span class="check">✓</span> 1 Super Likes por dia</li>
                <li class="disabled"><span class="cross">✕</span> Ver quem te curtiu</li>
                <li class="disabled"><span class="cross">✕</span> Sem anúncios</li>
            </ul>

            <button class="btn-subscribe btn-current" disabled *ngIf="!isUserPremium">
                Plano Atual
            </button>
            <button class="btn-subscribe btn-outline" *ngIf="isUserPremium" (click)="openDowngradeModal()">
                Voltar para Grátis
            </button>
            <!-- No button if premium user looking at free plan, simpler UI -->
        </div>

        <!-- PREMIUM PLAN CARDS -->
        <div class="plan-card" *ngFor="let plan of plans" [class.active-plan]="isUserPremium">
            <div class="plan-selection-indicator">
                <input type="radio" [checked]="isUserPremium" disabled>
                <span *ngIf="isUserPremium">Seu plano atual</span>
            </div>
            <div class="plan-header">
                <h2>{{ plan.name }}</h2>
                <div class="price">R$ {{ plan.price | number:'1.2-2' }}</div>
                <div class="duration">/ mês</div>
            </div>

            <ul class="features">
                <li><span class="check">✓</span> Encontre pessoas</li>
                <li><span class="check">✓</span> 3x Mais Likes por dia</li>
                <li><span class="check">✓</span> 3 Super Likes por dia</li>
                <li><span class="check">✓</span> Botão "Desfazer" no Feed</li>
                <li><span class="check">✓</span> Ver quem te curtiu</li>
                <li><span class="check">✓</span> Sem anúncios</li>
            </ul>

            <button class="btn-subscribe" (click)="selectPlan(plan)" *ngIf="!isUserPremium">
                Assinar {{ plan.name }}
            </button>
            <button class="btn-subscribe btn-current" disabled *ngIf="isUserPremium">
                Plano Atual
            </button>
        </div>
    </div>

    <div class="payment-container" *ngIf="selectedPlan && !pixQrCodeBase64">

        <!-- Payment Info Banner -->
        <div class="payment-info-banner"
            style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; border-radius: 4px; margin-bottom: 20px; font-size: 0.9rem; color: #0d47a1;">
            <p style="margin-bottom: 8px;"><strong>ℹ️ Como funciona o pagamento:</strong></p>
            <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                <li style="margin-bottom: 5px;"><strong>Pix:</strong> Pagamento único. Acesso liberado por 30 dias (não
                    renova sozinho).</li>
                <li><strong>Cartão de Crédito:</strong> Assinatura Mensal. Cobrança automática recorrente para você não
                    perder o acesso.</li>
            </ul>
        </div>

        <div class="payment-wrapper">
            <div id="paymentBrick_container"></div>

            <div class="subscription-disclaimer"
                style="text-align: center; margin-top: 15px; color: #666; font-size: 0.85rem; line-height: 1.4;">

                <p>Cancele a qualquer momento nas configurações do seu plano.</p>
                <p style="margin-top: 5px; font-size: 0.75rem; color: #999;">Ao assinar, você concorda com nossos Termos
                    de Uso.</p>
            </div>

            <div class="payment-loading-overlay" *ngIf="isProcessingPayment">
                <div class="spinner"></div>
                <p>Gerando Pagamento...</p>
            </div>
        </div>
    </div>

    <!-- Pix QR Code Display -->
    <div class="pix-container" *ngIf="pixQrCodeBase64">
        <h2>Pagamento via Pix</h2>
        <p>Escaneie o QR Code ou copie o código abaixo:</p>

        <div class="qr-code-wrapper">
            <img [src]="'data:image/png;base64,' + pixQrCodeBase64" alt="QR Code Pix" />
        </div>

        <div class="copy-paste-wrapper">
            <textarea readonly>{{ pixQrCodeCopyPaste }}</textarea>
            <button class="btn-copy" (click)="copyPixCode()">Copiar Código Pix</button>
        </div>

        <div class="instructions">
            <p>Após o pagamento, aguarde alguns instantes...</p>
        </div>
    </div>

    <div *ngIf="isLoading"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center;">
        <app-loader></app-loader>
    </div>

    <!-- Success Modal -->
    <div class="modal-overlay" *ngIf="showSuccessModal">
        <div class="success-modal">
            <div class="icon-circle">
                <i class="fas fa-check"></i>
            </div>
            <h2>Pagamento Aprovado!</h2>
            <p>Seu plano foi ativado com sucesso. Aproveite todos os benefícios exclusivos!</p>
            <button class="btn-primary" (click)="closeSuccessModal()">OK, Entendi</button>
        </div>
    </div>

    <!-- Downgrade Info Modal -->
    <div class="modal-overlay" *ngIf="showDowngradeModal">
        <div class="success-modal">
            <div class="icon-circle" style="background: #FF9800;">
                <i class="fas fa-info" style="color: white;"></i>
            </div>
            <h2>Confirmação</h2>
            <p *ngIf="premiumExpiresAt">
                Você é Premium até <strong>{{ premiumExpiresAt | date:'dd/MM/yyyy' }}</strong>.
                <br>
                A partir desta data, sua assinatura expira e você voltará para o plano Grátis automaticamente.
            </p>
            <p *ngIf="!premiumExpiresAt">
                Sua assinatura Premium expira em breve e sua conta retornará ao plano Grátis automaticamente.
            </p>
            <button class="btn-primary" (click)="closeDowngradeModal()">Entendi</button>
        </div>
    </div>
</div>
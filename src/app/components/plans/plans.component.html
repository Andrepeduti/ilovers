<div class="plans-container">
    <div class="header" *ngIf="!selectedPlan">
        <h1>Escolha seu Plano</h1>
        <p>Desbloqueie recursos exclusivos e encontre seu par perfeito mais rápido.</p>
    </div>

    <button class="btn-back" *ngIf="!selectedPlan" (click)="navigateToProfile()">
        <i class="fas fa-arrow-left"></i> Voltar
    </button>
    <button class="btn-back" *ngIf="selectedPlan" (click)="clearSelection()">
        <i class="fas fa-arrow-left"></i> Voltar
    </button>

    <div class="header" *ngIf="selectedPlan">
        <h1>{{ selectedPlan.name }}</h1>
        <p>Valor: R$ {{ selectedPlan.price | number:'1.2-2' }}</p>
    </div>

    <!-- Plan List -->
    <div class="plans-grid" *ngIf="!isLoading && !selectedPlan">

        <!-- FREE PLAN CARD -->
        <div class="plan-card" [class.active-plan]="!isUserPremium">
            <div class="plan-selection-indicator">
                <input type="radio" [checked]="!isUserPremium" disabled>
                <span *ngIf="!isUserPremium">Seu plano atual</span>
            </div>
            <div class="plan-header">
                <h2>Ilovers Free</h2>
                <div class="price">R$ 0,00</div>
                <div class="duration">/ Sempre gratuito</div>
            </div>

            <ul class="features">
                <li><span class="check">✓</span> Encontre pessoas</li>
                <li><span class="check">✓</span> Likes limitados por dia</li>
                <li><span class="check">✓</span> 1 Super Likes por dia</li>
                <li class="disabled"><span class="cross">✕</span> Ver quem te curtiu</li>
                <li class="disabled"><span class="cross">✕</span> Sem anúncios</li>
            </ul>

            <button class="btn-subscribe btn-current" disabled *ngIf="!isUserPremium">
                Plano Atual
            </button>
            <button class="btn-subscribe btn-outline" *ngIf="isUserPremium" (click)="openDowngradeModal()">
                Voltar para Grátis
            </button>
            <!-- No button if premium user looking at free plan, simpler UI -->
        </div>

        <!-- PREMIUM PLAN CARDS -->
        <div class="plan-card" *ngFor="let plan of plans" [class.active-plan]="isUserPremium">
            <div class="plan-selection-indicator">
                <input type="radio" [checked]="isUserPremium" disabled>
                <span *ngIf="isUserPremium">Seu plano atual</span>
            </div>
            <div class="plan-header">
                <h2>{{ plan.name }}</h2>
                <div class="price">R$ {{ plan.price | number:'1.2-2' }}</div>
                <div class="duration">/ mês</div>
            </div>

            <ul class="features">
                <li><span class="check">✓</span> Encontre pessoas</li>
                <li><span class="check">✓</span> 3x Mais Likes por dia</li>
                <li><span class="check">✓</span> 3 Super Likes por dia</li>
                <li><span class="check">✓</span> Botão "Desfazer" no Feed</li>
                <li><span class="check">✓</span> Ver quem te curtiu</li>
                <li><span class="check">✓</span> Sem anúncios</li>
            </ul>

            <button class="btn-subscribe" (click)="selectPlan(plan)" *ngIf="!isUserPremium">
                Assinar {{ plan.name }}
            </button>
            <button class="btn-subscribe btn-current" disabled *ngIf="isUserPremium">
                Plano Atual
            </button>
        </div>
    </div>

    <div class="payment-container" *ngIf="selectedPlan && !pixQrCodeBase64">

        <!-- Payment Method Selection -->
        <div class="payment-methods-wrapper"
            style="max-width: 400px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px;">

            <div class="payment-info-banner"
                style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; border-radius: 4px; margin-bottom: 20px; font-size: 0.9rem; color: #0d47a1;">
                <p style="margin-bottom: 8px;"><strong>ℹ️ Escolha como pagar:</strong></p>
                <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                    <li style="margin-bottom: 5px;"><strong>Cartão de Crédito:</strong> Assinatura Mensal (Cobrança
                        Automática).</li>
                    <li><strong>Pix:</strong> Pagamento Único (30 dias). Acesso imediato sem renovação automática.</li>
                </ul>
            </div>

            <!-- Credit Card Button (Initial State) -->
            <button class="btn-subscribe" *ngIf="paymentMethodSelected !== 'credit_card'" (click)="payWithCreditCard()"
                [disabled]="isProcessingPayment"
                style="background-color: #009EE3; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <i class="fas fa-credit-card"></i>
                <span>Assinar com Cartão de Crédito</span>
            </button>

            <!-- Payment Brick Container (Active State) -->
            <div *ngIf="paymentMethodSelected === 'credit_card'" style="width: 100%;">
                <div id="payment-brick-container"></div>

                <button (click)="cancelPayment()"
                    style="margin-top: 10px; background: none; border: none; color: #666; cursor: pointer; text-decoration: underline; width: 100%; font-size: 0.9rem;">
                    Cancelar / Escolher outro método
                </button>
            </div>

            <button class="btn-subscribe" (click)="payWithPix()" [disabled]="isProcessingPayment"
                style="background-color: #32BCAD; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <i class="fas fa-qrcode" *ngIf="!isProcessingPayment || paymentMethodSelected !== 'pix'"></i>
                <span *ngIf="!isProcessingPayment || paymentMethodSelected !== 'pix'">Pagar com Pix (Único)</span>

                <div class="spinner-small" *ngIf="isProcessingPayment && paymentMethodSelected === 'pix'"></div>
                <span *ngIf="isProcessingPayment && paymentMethodSelected === 'pix'">Gerando Pix...</span>
            </button>

            <div class="subscription-disclaimer"
                style="text-align: center; margin-top: 15px; color: #666; font-size: 0.85rem; line-height: 1.4;">
                <p>Ambiente seguro Mercado Pago.</p>
                <p style="margin-top: 5px; font-size: 0.75rem; color: #999;">Ao continuar, você concorda com nossos
                    Termos de Uso.</p>
            </div>

        </div>

        <!-- Hidden Loading for logic (optional display) -->
        <!-- <div class="payment-loading-overlay" *ngIf="isProcessingPayment">
            <div class="spinner"></div>
            <p>Processando...</p>
        </div> -->
    </div>

    <!-- Pix QR Code Display -->
    <div class="pix-container" *ngIf="pixQrCodeBase64">
        <h2>Pagamento via Pix</h2>
        <p>Escaneie o QR Code ou copie o código abaixo:</p>

        <div class="qr-code-wrapper">
            <img [src]="'data:image/png;base64,' + pixQrCodeBase64" alt="QR Code Pix" />
        </div>

        <div class="copy-paste-wrapper">
            <textarea readonly>{{ pixQrCodeCopyPaste }}</textarea>
            <button class="btn-copy" (click)="copyPixCode()">Copiar Código Pix</button>
        </div>

        <div class="instructions">
            <p>Após o pagamento, aguarde alguns instantes...</p>
        </div>
    </div>

    <div *ngIf="isLoading"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center;">
        <app-loader></app-loader>
    </div>

    <!-- Success Modal -->
    <div class="modal-overlay" *ngIf="showSuccessModal">
        <div class="success-modal">
            <div class="icon-circle">
                <i class="fas fa-check"></i>
            </div>
            <h2>Pagamento Aprovado!</h2>
            <p>Seu plano foi ativado com sucesso. Aproveite todos os benefícios exclusivos!</p>
            <button class="btn-primary" (click)="closeSuccessModal()">OK, Entendi</button>
        </div>
    </div>

    <!-- Downgrade Info Modal -->
    <div class="modal-overlay" *ngIf="showDowngradeModal">
        <div class="success-modal">
            <div class="icon-circle" style="background: #FF9800;">
                <i class="fas fa-info" style="color: white;"></i>
            </div>
            <h2>Confirmação</h2>
            <p *ngIf="premiumExpiresAt">
                Você é Premium até <strong>{{ premiumExpiresAt | date:'dd/MM/yyyy' }}</strong>.
                <br>
                A partir desta data, sua assinatura expira e você voltará para o plano Grátis automaticamente.
            </p>
            <p *ngIf="!premiumExpiresAt">
                Sua assinatura Premium expira em breve e sua conta retornará ao plano Grátis automaticamente.
            </p>
            <button class="btn-primary" (click)="closeDowngradeModal()">Entendi</button>
        </div>
    </div>
</div>
<app-loader *ngIf="loading && profiles.length === 0"></app-loader>

<div class="feed-container" *ngIf="currentProfile">
    <div class="card" *ngFor="let profile of profiles.slice(currentIndex, currentIndex + 1)"
        [@cardAnimation]="animationState" (mousedown)="onTouchStart($event)" (mouseup)="onTouchEnd($event)"
        (touchstart)="onTouchStart($event)" (touchend)="onTouchEnd($event)">

        <!-- Photo Indicators -->
        <div class="photo-indicators">
            <div class="indicator-bar" *ngFor="let img of profile.photos; let i = index"
                [class.active]="i === currentPhotoIndex">
            </div>
        </div>

        <img [src]="profile.photos[currentPhotoIndex]" [alt]="profile.displayName" class="profile-image">

        <div class="overlay-gradient"></div>

        <div class="profile-info">
            <h1>
                <span class="name">{{ profile.displayName }}</span>
                <span class="age" *ngIf="profile.age">{{ profile.age }}</span>
            </h1>
            <div class="location-row">
                <p class="distance"><i class="fas fa-map-marker-alt"></i> {{ profile.city }} - {{
                    profile.state }}</p>

                <button class="info-btn" (click)="$event.stopPropagation(); toggleDetails()"
                    (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()">
                    <i class="fas fa-info"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Super Like Animation Element -->
    <div class="super-like-overlay" *ngIf="isSuperLikeActive">
        <i class="fas fa-star super-star"></i>
        <h1 class="super-like-text">SUPER LIKE!</h1>
    </div>

    <!-- Actions Bar - Moved inside a wrapper for overlay -->
    <div class="card-overlay-actions">
        <div class="actions-bar">
            <button class="action-btn undo" (click)="onUndo()" [class.rotate-back]="isUndoActive"
                [disabled]="currentIndex === 0 || !isPremium"
                [title]="!isPremium ? 'Disponível apenas para Pro' : 'Desfazer'"
                [style.opacity]="(currentIndex === 0 || !isPremium) ? '0.5' : '1'">
                <i class="fas fa-undo"></i>
            </button>
            <button class="action-btn reject" (click)="onReject()" [class.shake-x]="isRejectActive">
                <i class="fas fa-times"></i>
            </button>
            <div class="action-btn-wrapper">
                <span class="limit-badge" *ngIf="limits.likes < 100">{{ limits.likes }}</span>
                <button class="action-btn like" (click)="onLike()" [class.pulse-heart]="isLikeActive"
                    [disabled]="limits.likes <= 0"
                    [title]="limits.likes <= 0 ? 'Limite diário de Likes atingido' : 'Like'">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
            <div class="action-btn-wrapper">
                <span class="limit-badge super-like-badge">{{ limits.superLikes }}</span>
                <button class="action-btn super-like" (click)="onSuperLike()"
                    [class.fake-disabled]="limits.superLikes <= 0">
                    <i class="fas fa-star"></i>
                </button>

                <!-- Popover for Free Plan (Super Like) -->
                <div class="upgrade-popover" *ngIf="showUpgradePopover && limits.superLikes <= 0">
                    <p>por hoje é só!</p>
                    <button class="upgrade-btn" (click)="goToPlans()">Seja Pro</button>
                    <div class="arrow-down"></div>
                </div>

                <!-- Popover for Rewind -->
                <div class="upgrade-popover rewind-popover" *ngIf="showUpgradePopover && limits.superLikes > 0">
                    <p>Recurso Pro</p>
                    <button class="upgrade-btn" (click)="goToPlans()">Seja Pro</button>
                    <div class="arrow-down"></div>
                </div>

                <!-- Timer for Pro Plan -->
                <div *ngIf="isPremium && limits.superLikes <= 0" class="reset-timer" [class.shake]="shakeTimer">
                    <span>Renova em {{ timeUntilReset }}</span>
                </div>
            </div>
        </div>
    </div>


    <!-- Expanded Profile Details Modal -->
    <div class="profile-details-modal" [class.active]="isDetailsActive">
        <button class="close-details-btn" (click)="toggleDetails()">
            <i class="fas fa-chevron-down"></i>
        </button>

        <div class="details-content">
            <div class="details-header">
                <h1>{{ currentProfile.displayName }} <span class="age" *ngIf="currentProfile.age">- {{
                        currentProfile.age
                        }}</span>
                </h1>
                <p class="distance-detail"><i class="fas fa-map-marker-alt"></i> {{ currentProfile.city }} - {{
                    currentProfile.state }}</p>
            </div>

            <hr class="divider">

            <div class="details-section">
                <h3>Sobre</h3>
                <p class="bio-text">{{ currentProfile.bio }}</p>
            </div>

            <div class="details-section" *ngIf="currentProfile.hobbies && currentProfile.hobbies.length > 0">
                <h3>Interesses</h3>
                <div class="tags-detail">
                    <span class="tag-detail" *ngFor="let hobby of currentProfile.hobbies">{{ hobby }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<app-match-modal *ngIf="showMatchModal" [matchedProfile]="matchedProfileData" [myPhoto]="myPhotoUrl"
    (close)="closeMatchModal()" (startChat)="startChatFromMatch()">
</app-match-modal>

<!-- Empty State - Display explicitly when not loading and no profile -->
<div *ngIf="!loading && !currentProfile">
    <ng-container *ngTemplateOutlet="emptyStateTemplate"></ng-container>
</div>

<ng-template #emptyStateTemplate>
    <div class="empty-feed">
        <div class="radar-container">
            <div class="radar-ring"></div>
            <div class="radar-ring"></div>
            <div class="radar-ring"></div>
            <div class="radar-core">
                <i class="fas fa-search"></i>
            </div>
        </div>

        <div class="empty-message">
            <h2>Ops! Por enquanto é só.</h2>
            <p>Estamos procurando novas pessoas incríveis perto de você. Volte em breve!</p>
        </div>

        <button class="btn-refresh" (click)="refreshFeed()">
            <i class="fas fa-redo"></i> Tentar Novamente
        </button>
    </div>
</ng-template>

<!-- Font Awesome for Icons (assuming it's loaded globally or we need to add CDN) -->
<!-- Adding a link here for simplicity if not in index.html, but better in index.html -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">